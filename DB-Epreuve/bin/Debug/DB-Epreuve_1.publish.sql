/*
Deployment script for DB_Epreuve

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "DB_Epreuve"
:setvar DefaultFilePrefix "DB_Epreuve"
:setvar DefaultDataPath "C:\Users\m.gitton\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\m.gitton\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_Produit_ToCategorie]...';


GO
ALTER TABLE [dbo].[Produit] DROP CONSTRAINT [FK_Produit_ToCategorie];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_Image_ToProduit]...';


GO
ALTER TABLE [dbo].[Image] DROP CONSTRAINT [FK_Image_ToProduit];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_Panier_ToProduit]...';


GO
ALTER TABLE [dbo].[Panier] DROP CONSTRAINT [FK_Panier_ToProduit];


GO
PRINT N'Starting rebuilding table [dbo].[Categorie]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Categorie] (
    [Id_Categorie]      INT           IDENTITY (1, 1) NOT NULL,
    [Produit_Categorie] NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id_Categorie] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Categorie])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Categorie] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Categorie] ([Id_Categorie], [Produit_Categorie])
        SELECT   [Id_Categorie],
                 [Produit_Categorie]
        FROM     [dbo].[Categorie]
        ORDER BY [Id_Categorie] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Categorie] OFF;
    END

DROP TABLE [dbo].[Categorie];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Categorie]', N'Categorie';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Commande]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Commande] (
    [Id_Commande]   INT      IDENTITY (1, 1) NOT NULL,
    [Date_Commande] DATETIME NOT NULL,
    PRIMARY KEY CLUSTERED ([Id_Commande] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Commande])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Commande] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Commande] ([Id_Commande], [Date_Commande])
        SELECT   [Id_Commande],
                 [Date_Commande]
        FROM     [dbo].[Commande]
        ORDER BY [Id_Commande] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Commande] OFF;
    END

DROP TABLE [dbo].[Commande];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Commande]', N'Commande';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Image]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Image] (
    [Id_Image]   INT            IDENTITY (1, 1) NOT NULL,
    [Nom_Image]  NVARCHAR (100) NOT NULL,
    [Url]        NVARCHAR (100) NOT NULL,
    [Id_Produit] INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([Id_Image] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Image])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Image] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Image] ([Id_Image], [Nom_Image], [Url], [Id_Produit])
        SELECT   [Id_Image],
                 [Nom_Image],
                 [Url],
                 [Id_Produit]
        FROM     [dbo].[Image]
        ORDER BY [Id_Image] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Image] OFF;
    END

DROP TABLE [dbo].[Image];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Image]', N'Image';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Panier]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Panier] (
    [Id_Panier]   INT IDENTITY (1, 1) NOT NULL,
    [Quantite]    INT NOT NULL,
    [Id_Produit]  INT NOT NULL,
    [Id_Commande] INT NOT NULL,
    PRIMARY KEY CLUSTERED ([Id_Panier] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Panier])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Panier] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Panier] ([Id_Panier], [Quantite], [Id_Produit], [Id_Commande])
        SELECT   [Id_Panier],
                 [Quantite],
                 [Id_Produit],
                 [Id_Commande]
        FROM     [dbo].[Panier]
        ORDER BY [Id_Panier] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Panier] OFF;
    END

DROP TABLE [dbo].[Panier];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Panier]', N'Panier';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Produit]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Produit] (
    [Id_Produit]   INT            IDENTITY (1, 1) NOT NULL,
    [Nom_Produit]  NVARCHAR (100) NOT NULL,
    [Description]  NVARCHAR (500) NOT NULL,
    [Prix]         MONEY          NOT NULL,
    [EcoScore]     NCHAR (10)     NOT NULL,
    [Id_Categorie] INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([Id_Produit] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Produit])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Produit] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Produit] ([Id_Produit], [Nom_Produit], [Description], [Prix], [EcoScore], [Id_Categorie])
        SELECT   [Id_Produit],
                 [Nom_Produit],
                 [Description],
                 [Prix],
                 [EcoScore],
                 [Id_Categorie]
        FROM     [dbo].[Produit]
        ORDER BY [Id_Produit] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Produit] OFF;
    END

DROP TABLE [dbo].[Produit];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Produit]', N'Produit';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Foreign Key [dbo].[FK_Produit_ToCategorie]...';


GO
ALTER TABLE [dbo].[Produit] WITH NOCHECK
    ADD CONSTRAINT [FK_Produit_ToCategorie] FOREIGN KEY ([Id_Categorie]) REFERENCES [dbo].[Categorie] ([Id_Categorie]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Image_ToProduit]...';


GO
ALTER TABLE [dbo].[Image] WITH NOCHECK
    ADD CONSTRAINT [FK_Image_ToProduit] FOREIGN KEY ([Id_Produit]) REFERENCES [dbo].[Produit] ([Id_Produit]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Panier_ToProduit]...';


GO
ALTER TABLE [dbo].[Panier] WITH NOCHECK
    ADD CONSTRAINT [FK_Panier_ToProduit] FOREIGN KEY ([Id_Produit]) REFERENCES [dbo].[Produit] ([Id_Produit]);


GO
PRINT N'Refreshing Procedure [dbo].[SP_Categorie_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Categorie_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Categorie_GetAll]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Categorie_GetAll]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Categorie_GetById]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Categorie_GetById]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Categorie_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Categorie_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Categorie_Update]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Categorie_Update]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Comande_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Comande_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Commande_GetAll]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Commande_GetAll]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Commande_GetById]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Commande_GetById]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Commande_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Commande_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Commande_Update]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Commande_Update]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Image_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Image_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Image_GetAll]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Image_GetAll]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Image_GetById]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Image_GetById]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Image_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Image_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Image_Update]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Image_Update]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Panier_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Panier_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Panier_GetAll]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Panier_GetAll]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Panier_GetById]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Panier_GetById]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Panier_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Panier_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Panier_Update]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Panier_Update]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Produit_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Produit_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Produit_GetAll]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Produit_GetAll]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Produit_GetById]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Produit_GetById]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Produit_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Produit_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[SP_Produit_Update]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SP_Produit_Update]';


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Produit] WITH CHECK CHECK CONSTRAINT [FK_Produit_ToCategorie];

ALTER TABLE [dbo].[Image] WITH CHECK CHECK CONSTRAINT [FK_Image_ToProduit];

ALTER TABLE [dbo].[Panier] WITH CHECK CHECK CONSTRAINT [FK_Panier_ToProduit];


GO
PRINT N'Update complete.';


GO
